# Dockerfile.relay - Lightweight Sovereign Agent Relay
#
# This builds a minimal image for running just the API relay service.
# Use this on your trusted server to forward requests to OpenRouter.
#
# Usage:
#   docker build -f Dockerfile.relay -t sovereign-relay .
#   docker run -d -p 127.0.0.1:8080:8080 -v ./config.json:/app/config.json:ro sovereign-relay
#
# The image includes the full repo for the /bundle.tar.gz endpoint to serve to clients.

FROM oven/bun:1.1-alpine

LABEL org.opencontainers.image.title="Sovereign Agent Relay"
LABEL org.opencontainers.image.description="API relay for Sovereign Agent"
LABEL org.opencontainers.image.source="https://github.com/lachlan-jones5/sovereign-agent"

# Install curl for health checks and git for cloning
RUN apk add --no-cache curl git

WORKDIR /app

# Copy full repo (needed for /bundle.tar.gz endpoint)
# Note: .git is excluded by .dockerignore, so we clone submodules separately
COPY . .

# Clone vendor submodules (since .git is not copied)
# Remove any empty directories first, then clone fresh
# Note: oh-my-opencode default branch is 'dev', we need 'master' for our changes
RUN rm -rf vendor/opencode vendor/oh-my-opencode && \
    mkdir -p vendor && \
    git clone --depth 1 https://github.com/lachlan-jones5/opencode.git vendor/opencode && \
    git clone --depth 1 --branch master https://github.com/lachlan-jones5/oh-my-opencode.git vendor/oh-my-opencode && \
    rm -rf vendor/opencode/.git vendor/oh-my-opencode/.git

# Create minimal package.json for relay
RUN echo '{"name":"sovereign-relay","type":"module"}' > ./relay/package.json

WORKDIR /app/relay

# Default environment
ENV CONFIG_PATH=/app/config.json
ENV REPO_PATH=/app
ENV RELAY_PORT=8080
ENV RELAY_HOST=0.0.0.0
ENV LOG_LEVEL=info

# Expose relay port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# Run the relay
CMD ["bun", "run", "main.ts"]
