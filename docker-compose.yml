# docker-compose.yml - Sovereign Agent
#
# Quick start:
#   1. Copy config.json.example to config.json and add your API key
#   2. docker compose run --rm agent
#
# Usage patterns:
#   # Start interactive session in current directory
#   docker compose run --rm agent
#
#   # Start with a specific project
#   docker compose run --rm -v /path/to/project:/workspace agent
#
#   # Shell access for debugging
#   docker compose run --rm agent bash
#
#   # Re-run installer (after config changes)
#   docker compose run --rm agent --install --skip-deps
#
# Security notes:
#   - Network is restricted to OpenRouter API and package registries only
#   - Private LAN ranges are blocked to prevent SSRF attacks (see lib/network-firewall.sh)
#   - Only the project directory is mounted (not home directory)
#   - Container runs with no-new-privileges and read-only root filesystem
#
# Network Security (Iron Box):
#   The container includes iptables rules that:
#   - Block private IP ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
#   - Only allow traffic to: openrouter.ai, npm/pypi registries, github.com
#   - Prevent SSRF attacks against local infrastructure
#
#   To enable strict network isolation, run with --cap-add=NET_ADMIN:
#   docker compose run --rm --cap-add=NET_ADMIN sovereign-agent
#
#   Or set ENABLE_NETWORK_FIREWALL=true in environment

services:
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    image: sovereign-agent:latest
    container_name: sovereign-agent
    
    # Interactive terminal
    stdin_open: true
    tty: true
    
    # Network restrictions for security
    networks:
      - sovereign-net
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem with specific writable paths
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /run:size=10M,mode=755
    
    volumes:
      # Mount current directory as workspace
      - .:/workspace
      
      # Mount config file
      - ./config.json:/app/config.json:ro
      
      # Persist OpenCode configuration between runs
      - opencode-config:/root/.config/opencode
      
      # Persist session history (SQLite database)
      - opencode-data:/root/.local/share/opencode
      
      # Optional: mount SSH keys for git operations
      # - ~/.ssh:/root/.ssh:ro
      
      # Optional: mount git config
      # - ~/.gitconfig:/root/.gitconfig:ro
    
    environment:
      # Pass through API key if set in environment
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      
      # Optional: custom config path
      - CONFIG_PATH=/app/config.json
      
      # Enable network firewall (requires --cap-add=NET_ADMIN)
      # Set to "true" to apply iptables rules on container start
      - ENABLE_NETWORK_FIREWALL=${ENABLE_NETWORK_FIREWALL:-false}
    
    working_dir: /workspace

networks:
  sovereign-net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "true"
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

volumes:
  opencode-config:
    name: sovereign-agent-config
  opencode-data:
    name: sovereign-agent-data
